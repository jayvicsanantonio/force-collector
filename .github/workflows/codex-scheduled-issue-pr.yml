name: Codex - Scheduled Issue PR

on:
  schedule:
    # GitHub cron is UTC only.
    # We schedule both PST and PDT candidate times, then gate at runtime using America/Los_Angeles.
    # IMPORTANT: scheduled runs can be delayed by minutes/hours, so we must NOT gate on "current local hour".
    # Instead, we gate on the cron string that triggered the run: github.event.schedule.
    # - 07:00 PT == 15:00 UTC (PST) / 14:00 UTC (PDT)
    # - 19:00 PT == 03:00 UTC (PST) / 02:00 UTC (PDT)
    - cron: '0 2 * * *'  # 19:00 PDT
    - cron: '0 3 * * *'  # 19:00 PST
    - cron: '0 14 * * *' # 07:00 PDT
    - cron: '0 15 * * *' # 07:00 PST
  workflow_dispatch: {}

concurrency:
  group: codex-scheduled-issue-pr
  cancel-in-progress: false

permissions:
  contents: write
  pull-requests: write
  issues: write

jobs:
  codex:
    runs-on: ubuntu-latest
    steps:
      - name: Guard (run only at 07:00/19:00 PT)
        id: guard
        shell: bash
        run: |
          set -euo pipefail
          if [[ "${{ github.event_name }}" != "schedule" ]]; then
            echo "skip=false" >> "$GITHUB_OUTPUT"
            echo "Not a scheduled run; skipping time guard."
            exit 0
          fi

          schedule="${{ github.event.schedule }}"
          pt_offset="$(TZ=America/Los_Angeles date +%z)"

          allow="false"
          if [[ "$pt_offset" == "-0800" ]]; then
            # PST: 07:00 PT == 15:00 UTC, 19:00 PT == 03:00 UTC
            if [[ "$schedule" == "0 15 * * *" || "$schedule" == "0 3 * * *" ]]; then
              allow="true"
            fi
          elif [[ "$pt_offset" == "-0700" ]]; then
            # PDT: 07:00 PT == 14:00 UTC, 19:00 PT == 02:00 UTC
            if [[ "$schedule" == "0 14 * * *" || "$schedule" == "0 2 * * *" ]]; then
              allow="true"
            fi
          fi

          if [[ "$allow" != "true" ]]; then
            echo "skip=true" >> "$GITHUB_OUTPUT"
            echo "Skipping: schedule=$schedule pt_offset=$pt_offset (America/Los_Angeles)."
            exit 0
          fi
          echo "skip=false" >> "$GITHUB_OUTPUT"

      - name: Checkout
        if: steps.guard.outputs.skip != 'true'
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Prepare temp paths
        if: steps.guard.outputs.skip != 'true'
        id: paths
        shell: bash
        run: |
          set -euo pipefail
          tmp_dir="${RUNNER_TEMP}/codex"
          mkdir -p "$tmp_dir"
          echo "tmp_dir=$tmp_dir" >> "$GITHUB_OUTPUT"
          echo "issue_json=$tmp_dir/issue.json" >> "$GITHUB_OUTPUT"
          echo "prompt_file=$tmp_dir/codex-prompt.md" >> "$GITHUB_OUTPUT"
          echo "output_file=$tmp_dir/codex-output.md" >> "$GITHUB_OUTPUT"

      - name: Ensure labels exist
        if: steps.guard.outputs.skip != 'true'
        env:
          GH_TOKEN: ${{ github.token }}
        shell: bash
        run: |
          set -euo pipefail
          repo="${{ github.repository }}"
          gh label create "codex" --repo "$repo" --color "5319e7" --description "Codex-generated work" --force || true
          gh label create "codex-in-progress" --repo "$repo" --color "0E8A16" --description "Codex is currently working this issue" --force || true
          gh label create "codex-pr-open" --repo "$repo" --color "1D76DB" --description "A Codex PR has been opened for this issue" --force || true
          gh label create "codex-failed" --repo "$repo" --color "D73A4A" --description "Codex attempted but failed; needs manual triage" --force || true
          gh label create "codex-noop" --repo "$repo" --color "BFDADC" --description "Codex ran but made no changes" --force || true
          gh label create "codex-skip" --repo "$repo" --color "FFFFFF" --description "Skip this issue for scheduled Codex runs" --force || true

      - name: Pick next unaddressed issue (lowest number)
        if: steps.guard.outputs.skip != 'true'
        id: pick
        env:
          GH_TOKEN: ${{ github.token }}
        shell: bash
        run: |
          set -euo pipefail

          python3 - <<'PY'
          import json
          import os
          import subprocess

          repo = os.environ["GITHUB_REPOSITORY"]
          owner = os.environ["GITHUB_REPOSITORY_OWNER"]
          out_path = os.environ["GITHUB_OUTPUT"]

          # Eligible issues are open issues assigned to the repo owner, excluding:
          # - issues already being worked ("codex-in-progress")
          # - issues that already have a Codex PR ("codex-pr-open")
          # - issues explicitly skipped by a human ("codex-skip")
          skip_labels = {"codex-in-progress", "codex-pr-open", "codex-skip"}

          cmd = [
              "gh",
              "issue",
              "list",
              "--repo",
              repo,
              "--assignee",
              owner,
              "--state",
              "open",
              "--limit",
              "200",
              "--json",
              "number,title,url,labels",
          ]
          raw = subprocess.check_output(cmd, text=True)
          issues = json.loads(raw)

          candidates = []
          for issue in issues:
              labels = {lbl["name"] for lbl in (issue.get("labels") or [])}
              if labels & skip_labels:
                  continue
              candidates.append(issue)

          if not candidates:
              with open(out_path, "a", encoding="utf-8") as f:
                  f.write("issue_number=\n")
              print("No eligible open issues assigned to the repo owner.")
              raise SystemExit(0)

          issue = sorted(candidates, key=lambda x: x["number"])[0]
          issue_number = str(issue["number"])
          issue_title = issue["title"]
          issue_url = issue["url"]

          def write_output(k: str, v: str) -> None:
              with open(out_path, "a", encoding="utf-8") as f:
                  f.write(f"{k}<<__EOF__\n{v}\n__EOF__\n")

          with open(out_path, "a", encoding="utf-8") as f:
              f.write(f"issue_number={issue_number}\n")
          write_output("issue_title", issue_title)
          write_output("issue_url", issue_url)
          print(f"Picked issue #{issue_number}: {issue_title}")
          PY

      - name: Mark issue in progress
        if: steps.pick.outputs.issue_number != ''
        env:
          GH_TOKEN: ${{ github.token }}
        shell: bash
        run: |
          set -euo pipefail
          repo="${{ github.repository }}"
          issue_number="${{ steps.pick.outputs.issue_number }}"
          run_url="${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"

          gh issue edit "$issue_number" --repo "$repo" --add-label "codex-in-progress"
          gh issue comment "$issue_number" --repo "$repo" --body "Codex started work in scheduled run: $run_url"

      - name: Create work branch
        if: steps.pick.outputs.issue_number != ''
        id: branch
        shell: bash
        run: |
          set -euo pipefail
          branch="codex/issue-${{ steps.pick.outputs.issue_number }}-${{ github.run_id }}"
          echo "branch=$branch" >> "$GITHUB_OUTPUT"

          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git checkout -b "$branch"

      - name: Fetch issue details
        if: steps.pick.outputs.issue_number != ''
        env:
          GH_TOKEN: ${{ github.token }}
        shell: bash
        run: |
          set -euo pipefail
          gh issue view "${{ steps.pick.outputs.issue_number }}" --repo "${{ github.repository }}" --json title,body,url > "${{ steps.paths.outputs.issue_json }}"

      - name: Build Codex prompt
        if: steps.pick.outputs.issue_number != ''
        shell: bash
        run: |
          set -euo pipefail

          python3 - <<'PY'
          import json
          import os
          from pathlib import Path

          repo = os.environ["GITHUB_REPOSITORY"]
          issue_json = os.environ["CODEX_ISSUE_JSON"]
          prompt_file = os.environ["CODEX_PROMPT_FILE"]
          issue = json.loads(Path(issue_json).read_text(encoding="utf-8"))
          number = os.environ.get("ISSUE_NUMBER") or ""
          title = issue["title"]
          url = issue["url"]
          body = issue["body"] or ""

          prompt_parts = [
              f"You are Codex running in GitHub Actions on repository `{repo}`.",
              "",
              f"Task: Implement GitHub Issue #{number}: {title}",
              f"Issue URL: {url}",
              "",
              "## Source of truth: issue body",
              body,
              "",
              "## Constraints",
              f"- Work ONLY on Issue #{number}. Do not address other issues.",
              "- Follow the issue acceptance criteria exactly; keep changes minimal and scoped.",
              "- Add or update tests when appropriate; run existing tests/build commands if present.",
              "- Do not create a pull request (the workflow will do it).",
              "- Do not change GitHub Actions workflows unless the issue explicitly requires it.",
              "",
              "## Deliverable",
              "- Make code changes in the repo so the issue can be merged when reviewed.",
              "- In your final message, include:",
              "  - What changed",
              "  - How to test (commands)",
              "  - Any limitations / follow-ups",
              "",
          ]
          Path(prompt_file).write_text("\n".join(prompt_parts), encoding="utf-8")
          PY
        env:
          ISSUE_NUMBER: ${{ steps.pick.outputs.issue_number }}
          CODEX_ISSUE_JSON: ${{ steps.paths.outputs.issue_json }}
          CODEX_PROMPT_FILE: ${{ steps.paths.outputs.prompt_file }}

      - name: Run Codex
        if: steps.pick.outputs.issue_number != ''
        id: codex
        uses: openai/codex-action@v1
        with:
          openai-api-key: ${{ secrets.OPENAI_API_KEY }}
          prompt-file: ${{ steps.paths.outputs.prompt_file }}
          output-file: ${{ steps.paths.outputs.output_file }}
          safety-strategy: drop-sudo
          sandbox: workspace-write
          codex-args: '["--config","approval_policy=\"never\"","--config","sandbox_workspace_write.network_access=true"]'

      - name: Commit changes (if any)
        if: steps.pick.outputs.issue_number != ''
        id: commit
        shell: bash
        run: |
          set -euo pipefail

          if [[ -z "$(git status --porcelain)" ]]; then
            echo "changed=false" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          git add -A
          git commit -m "codex: issue #${{ steps.pick.outputs.issue_number }}"
          echo "changed=true" >> "$GITHUB_OUTPUT"

      - name: Push branch
        if: steps.commit.outputs.changed == 'true'
        shell: bash
        run: |
          set -euo pipefail
          git push --set-upstream origin "${{ steps.branch.outputs.branch }}"

      - name: Create pull request
        if: steps.commit.outputs.changed == 'true'
        id: pr
        env:
          # If repo setting "Allow GitHub Actions to create and approve pull requests" is disabled,
          # the default GITHUB_TOKEN cannot create PRs. Provide a PAT via GH_PAT to allow PR creation.
          GH_TOKEN: ${{ secrets.GH_PAT || github.token }}
        shell: bash
        run: |
          set -euo pipefail
          repo="${{ github.repository }}"
          base="${{ github.event.repository.default_branch }}"
          head="${{ steps.branch.outputs.branch }}"
          codex_output="${{ steps.paths.outputs.output_file }}"
          issue_number="${{ steps.pick.outputs.issue_number }}"
          issue_title="${{ steps.pick.outputs.issue_title }}"
          issue_url="${{ steps.pick.outputs.issue_url }}"
          run_url="${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"

          pr_title="Codex: #${issue_number} ${issue_title}"

          {
            echo "Closes #${issue_number}"
            echo
            echo "Issue: ${issue_url}"
            echo "Run: ${run_url}"
            echo
            echo "<details>"
            echo "<summary>Codex summary</summary>"
            echo
            if [[ -f "$codex_output" ]]; then
              cat "$codex_output"
            else
              echo "(No codex output captured.)"
            fi
            echo
            echo "</details>"
          } > pr_body.md

          pr_url="$(gh pr create --repo "$repo" --base "$base" --head "$head" --title "$pr_title" --body-file pr_body.md)"
          echo "url=$pr_url" >> "$GITHUB_OUTPUT"

          gh pr edit "$pr_url" --repo "$repo" --add-assignee "${{ github.repository_owner }}" || true
          gh pr edit "$pr_url" --repo "$repo" --add-label "codex" || true

      - name: Mark issue PR opened
        if: steps.pr.outputs.url != ''
        env:
          GH_TOKEN: ${{ github.token }}
        shell: bash
        run: |
          set -euo pipefail
          repo="${{ github.repository }}"
          issue_number="${{ steps.pick.outputs.issue_number }}"
          pr_url="${{ steps.pr.outputs.url }}"

          gh issue comment "$issue_number" --repo "$repo" --body "Opened PR: $pr_url"
          gh issue edit "$issue_number" --repo "$repo" --remove-label "codex-in-progress" --add-label "codex-pr-open"

      - name: Mark issue no-op (Codex made no changes)
        if: steps.pick.outputs.issue_number != '' && steps.commit.outputs.changed != 'true'
        env:
          GH_TOKEN: ${{ github.token }}
        shell: bash
        run: |
          set -euo pipefail
          repo="${{ github.repository }}"
          issue_number="${{ steps.pick.outputs.issue_number }}"
          run_url="${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"

          gh issue comment "$issue_number" --repo "$repo" --body "Codex finished but produced no changes. Run: $run_url"
          gh issue edit "$issue_number" --repo "$repo" --remove-label "codex-in-progress" --add-label "codex-noop"

      - name: Mark issue failed (needs triage)
        if: failure() && steps.pick.outputs.issue_number != ''
        env:
          GH_TOKEN: ${{ github.token }}
        shell: bash
        run: |
          set -euo pipefail
          repo="${{ github.repository }}"
          issue_number="${{ steps.pick.outputs.issue_number }}"
          run_url="${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"

          gh issue comment "$issue_number" --repo "$repo" --body "Codex run failed. Run: $run_url"
          gh issue edit "$issue_number" --repo "$repo" --remove-label "codex-in-progress" --add-label "codex-failed" || true
